---
output: 
  html_document: 
    fig_height: 3
    fig_width: 7.5
    theme: cerulean
---
White Wine Quality Exploration by Rica Enriquez
========================================================
The white wine quality data set from Cortez et al. (2009) is explored. The wines
are classified as Vinho Verde and are exclusively produced in the demarcated
region of Vinho Verde in northwestern Portugal. These wines are described to
possess "vibrant freshness, elegance, lightness and aromatic and flavorful
expressions." The paper and data can be found here:

P. Cortez, A. Cerdeira, F. Aloesseida, T. Matos and J. Reis. Modeling wine
preferences by data mining from physicochemical properties. In Decision Support
Systems, Elsevier, 47(4):547-553. ISSN: 0167-9236.

The attributes included in the data set are described below (taken from
"wineQualityInfo.txt"):

1. Fixed acidity: most acids involved with wine or fixed or nonvolatile (does 
not evaporate readily)
2. Volatile acidity: the amount of acetic acid in wine, which at too high of 
levels can lead to an unpleasant, vinegar taste
3. Citric acid: found in small quantities, citric acid can add 'freshness' and
flavor to wines
4. Residual sugar: the amount of sugar remaining after fermentation stops, it's 
rare to find wines with less than 1 gram/liter and wines with greater than 45
grams/liter are considered sweet
5. Chlorides: the amount of salt in the wine
6. Free sulfur dioxide: the free form of SO2 exists in equilibrium between 
molecular SO2 (as a dissolved gas) and bisulfite ion; it prevents microbial 
growth and the oxidation of wine
7. Total sulfur dioxide: amount of free and bound forms of S02; in low 
concentrations, SO2 is mostly undetectable in wine, but at free SO2 
concentrations over 50 ppm, SO2 becomes evident in the nose and taste of wine
8. Density: the density of water is close to that of water depending on the 
percent alcohol and sugar content
9. pH: describes how acidic or basic a wine is on a scale from 0 (very acidic) 
to 14 (very basic); most wines are between 3-4 on the pH scale
10. Sulphates: a wine additive which can contribute to sulfur dioxide gas (S02)
levels, which acts as an antimicrobial and antioxidant
11. Alcohol: the percent alcohol content of the wine
12. Quality: score between 0 and 10

Based on the descriptions of Vinho Verde wines and the attributes in the data 
set, the features that are predicted to positively contribute to quality are:

1. Citric acid - adds freshness
2. Total sulfur dioxide - adds taste

The features that are predicted to negatively contribute to quality are:

1. Density - subtracts lightness
2. Volatile acidity - adds an unpleasant, vinegar taste

The following analysis explores the attributes in a systematic manner. The 
features that mainly influence quality are then further investigated.

```{r echo = FALSE, message = FALSE, warning = FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" is set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file.

library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(GGally)
library(psych)
library(gridExtra)
library(reshape2)

# Set ggplot themes to minimal and color scheme to div
theme_set(theme_minimal(12))
color_palette = "div"
```
#References
1. To create a function to loop over attributes and create individual plots
    + http://stackoverflow.com/questions/11547448/looping-over-ggplot2-with-
    columns
    
2. To create histograms of all attributes
    + http://stackoverflow.com/questions/21511823/histograms-using-ggplot2-
    within-loop  

#The Data Set
```{r echo = FALSE, Load_the_Data}
# Load the Data
wine <- read.csv('wineQualityWhites.csv')

# Make a new factored feature based on quality
wine$score <- factor(wine$quality)

str(wine)
summary(wine)

# Set low and high quantiles
low_q <- 0.05
high_q <- 0.95

# Axis quantile limit functions
xlim_quantile <- function(x_var, lower_limit, upper_limit) {
  xlim(quantile(x_var, lower_limit, names = FALSE), 
       quantile(x_var, upper_limit, names = FALSE))
}

ylim_quantile <- function(y_var, lower_limit, upper_limit) {
  ylim(quantile(y_var, lower_limit, names = FALSE), 
       quantile(y_var, upper_limit, names = FALSE))
}
```

There are 4898 white wines in the data set with 11 real features 
("fixed.acidity", "volatile.acidity", "citric.acid", "residual.sugar", 
"chlorides", "free.sulfur.dioxide", "total.sulfur.dioxide", "density", "pH", 
"sulphates", and "alcohol"). The analysis of the data set is centered on how 
these features are related to the "quality" of a wine. An extra variable, 
"score", is an ordered factor version of the "quality" feature. The "score" 
ranges from 0 - 10 (best).

Most wines are rated in the middle to mid-high (5-6), with a median "quality" of
6. Most features appears to have large outliers. "density" and "pH" might be 
exceptions. These characteristics might be easier to measure accurately than the
other features. The median "residual.sugar" content is 5.200 $g/dm^3$ and the 
median "alcohol" content is 10.51 vol.%.

##Histogram of Wine Qualities
A histogram of wind qualities can show if there is a skew in the rating of wines
and if they tend to be underrated or overrated.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram}

ggplot(aes(quality), data=subset(wine, !is.na(quality))) + 
  geom_histogram(binwidth = 1) + scale_x_discrete(breaks = 0:10)
```

The quality of white wines appear to follow somewhat of a normal distribution. 
The scale is from 0 - 10, but the lowest score given was a 3 (20 wines) and the
highest was a 9 (5 wines). Are there common profiles for the worst and best 
wines?

##Histograms
###Base Histograms of Wine Properties
A set of base histograms are created for all attributes.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 7.5, fig.height = 15,  cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram2}

wine_hist <- subset(wine, select = -c(X, quality, score))
ggplot(melt(wine_hist), aes(x = value)) + 
  facet_wrap(~ variable, scales = "free", ncol = 2) + 
  geom_histogram()

rm(wine_hist)
```

The plots above show the distribution of all of the features. The base
histograms show that "fixed.acidity", "citric.acid", "total.sulfur.dioxide",
"density", "pH", and "sulphates" are normally distributed while
"volatile.acidity", "residual.sugar", "chlorides", "free.sulfur.dioxide", and
"alcohol" have skewed distributions. However, binwidths and axes need adjustment
in order to find any unexpected distributions. Histograms of features that
provide significantly more information than the base histograms are presented
below.

###Altered Histogram of Citric Acid
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram3}

ggplot(subset(wine, !is.na(quality) & !is.na(citric.acid)), 
       aes(x = citric.acid, fill = score)) + 
  geom_histogram(binwidth = .02) +
  xlim(c(0, .8)) + 
  scale_fill_brewer(type = color_palette)
```

There appears to be a ~0.3 $g/dm^3$ peak and a ~0.5 $g/dm^3$ spike. It would be
interesting to know which wines have a citric acid content ~0.5 $g/dm^3$.

###Altered Histogram of Resdiual Sugar
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram4}

ggplot(subset(wine, !is.na(quality) & !is.na(residual.sugar)), 
       aes(x = residual.sugar, fill = score)) + 
  geom_histogram() + 
  scale_x_log10() + 
  scale_fill_brewer(type = color_palette)
```

There appears to be a bimodal distribution for residual sugar content. There are
probably wines for people who prefer drier wines and for others who prefer
sweeter wines. It would be interesting to know the properties of these two
subsets.

###Altered Histogram of Chlorides
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram5}

ggplot(subset(wine, !is.na(quality) & !is.na(chlorides)), 
       aes(x = chlorides, fill = score)) + 
  geom_histogram(binwidth = 0.05) +
  scale_x_log10() + 
  scale_fill_brewer(type = color_palette)
```

There is a long tail of higher chloride concentrations for the lower quality
wines. Is this possibly an important feature to distinguish wine quality?

###Altered Histogram of Free Sulfur Dioxide
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram6}

ggplot(subset(wine, !is.na(quality) & !is.na(free.sulfur.dioxide)), 
       aes(x = free.sulfur.dioxide, fill = score)) + 
  geom_histogram(binwidth = 5) + 
  xlim(c(0, 100)) + 
  scale_fill_brewer(type = color_palette)
```

The lower quality wines tend to have lower free sulfur dioxide concentrations. 
Perhaps wine with more free sulfur dioxide (less oxidized) taste better?

###Altered Histogram of Alcohol
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Histogram7}

ggplot(subset(wine, !is.na(quality) & !is.na(alcohol)), 
       aes(x = alcohol, fill = score)) + 
  geom_histogram(binwidth = 0.5) + 
  scale_fill_brewer(type = color_palette)
```

The higher quality wines tend to have more alcohol content. Could it be that 
alcohol makes wine taste better?

## Box Plots
###Box Plots of Wine Properties, Separated by Wine Quality
A set of box plots are created for all features. The data is limited to the
middle 90%. The mean for each category is plotted as an "x". Creating such 
boxplots should help see the trend of each feature by wine "quality" and also 
see the largest range of a feature at "quality: level.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', results = "hide", BoxPlot}

# Loop through all the features to make boxplots, separated by "score". Only the middle 90% of data is plotted and the mean of each feature for each "score" is plotted as an "x".
lapply((names(wine)[2:12]), 
       function(i) ggplot(subset(wine, !is.na(quality) & !is.na(i)), 
                          aes_string(x = "score", y = i, fill = "score")) +
         geom_boxplot() + 
         ylim_quantile(wine[[i]], low_q, high_q) +
         scale_fill_brewer(type = color_palette) + 
         stat_summary(fun.y = mean, geom = "point", shape = 4))
```

The features that appear to vary with wine quality are "volatile.acidity",
"citric.acid", "residual.sugar", "chlorides", "free.sulfur.dioxide",
"total.sulfur.dioxide", "density", "pH", and "alcohol". It seems that the
variation within a feature is more obvious through these set of box plots than
the previous set of histograms. The top features to affect "quality" appear to 
be "density" and "alcohol". The medians and means of "fixed.acidity" and
"sulphates" hardly vary with "quality". Thus, these features will not be 
explored further.

##Correlations and Scatterplots
Scatterplots and correlation calculations of the characteristics of wine that
might be more closely associated to quality should help ascertain which features
might be important to quality. Additionally, how the individual features
correlate with each other will be investigated. If certain features are strongly
related, a feature may be removed to avoid redundancy in a model. Which features
are strongly related is also explored.

###Matrix Plot for Selected Features
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 7.5, fig.height = 7.5, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Matrxplot}

# Remove the features that are no longer examined
wine <- subset(wine, select = -c(X, fixed.acidity, sulphates))

# Create a matrix of plots of the above features
pairs.panels(subset(wine, select = -score), ellipses = FALSE)
```

The "alcohol" feature has a strong correlation with wine quality. The "density"
feature has a moderately strong correlation with the quality of wine.
"residual.sugar" presents a bimodal distribution, and would not necessarily have
a strong linear correlation with wine quality. It will be explored further since
"density", and "alcohol" have strong correlations with "residual.sugar". In
fact, the correlation between "density" and "residual.sugar" is the strongest in
this set. Similarly, "total.sulfur.dioxide" has a strong correlation with
"density". "alcohol" also has a strong correlation with "chlorides" and
"total.sulfur.dioxide". The relation of these variables with each other and
quality will be analyzed more closely in the next section.

### Middle 90% of Alcohol vs. Density
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Scatterplot_1}

ggplot(wine, aes(x = alcohol, y = density, color = score)) + 
  geom_point() + 
  xlim_quantile(wine$alcohol, low_q, high_q) +
  ylim_quantile(wine$density, low_q, high_q) +
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)

# Color by "residual.sugar" - need to create a midpoint for continuous variables
mid<-median(subset(wine$residual.sugar, wine$residual.sugar < 25))
ggplot(wine, aes(x = alcohol, y = density, color = residual.sugar)) + 
  geom_point() + 
  xlim_quantile(wine$alcohol, low_q, high_q) +
  ylim_quantile(wine$density, low_q, high_q) +
  geom_smooth(method = "loess", color = "black") + 
  scale_color_gradient2(limits = c(0, 25), midpoint = mid, low = "magenta", 
                        mid = "white", high = "green" )
```

There is a strong negative linear relationship between "density"" and "alcohol".
As "alcohol" increases, "density"" decreases. The higher quality wines tend
cluster in the lower right region, which is the higher alcohol content, lower
"density" wines.  It would be interesting to see if this ratio is a better
feature. 

Since "density" and "alcohol" are highly correlated with 
"residual.sugar", the same plot is created (colored by "residual.sugar" content 
instead of "score") in order to better understand the relationship between these
features. There appears to be a clear separation between wines with higher
"residual.sugar" and lower "residual.sugar". The higher "residual.sugar" wines 
tend to have a higher density:alcohol ratio.

### Middle 90% of Alcohol vs. Residual Sugar
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Scatterplot_2}

ggplot(wine, aes(x = alcohol, y = residual.sugar, color = score)) + 
  geom_point() + 
  xlim_quantile(wine$alcohol, low_q, high_q) +
  ylim_quantile(wine$residual.sugar, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)
```

The "residual.sugar" decreases with increasing "alcohol". However, there isn't a
strong linear relationship between "residual.sugar" and "alcohol" for the whole
range. An exponential decay in "residual.sugar" appears to exist with increasing
"alcohol". The higher "quality" wines tend to have a higher "alcohol" and lower
"residual.sugar" content. If there is a strong relationship between
"residual.sugar" and "alcohol", perhaps only the "alcohol" feature needs to be 
kept for future analysis.

### Middle 90% of Alcohol vs. Total Sulfur Dioxide
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Scatterplot3}

ggplot(wine, aes(x = alcohol, y = total.sulfur.dioxide, color = score)) +
  geom_point() + 
  xlim_quantile(wine$alcohol, low_q, high_q) +
  ylim_quantile(wine$total.sulfur.dioxide, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)
```

There is a negative linear relationship between "total.sulfur.dioxide" and
"alcohol". As "alcohol" increases, "total.sulfur.dioxide" decreases. However, 
the relationship between the two and "quality" is not clear. For now, both 
features may be important to keep.

### Middle 90% of Alcohol vs. Chlorides
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Scatterplot4}

ggplot(wine, aes(x = alcohol, y = chlorides, color = score)) + 
  geom_point() + 
  xlim_quantile(wine$alcohol, low_q, high_q) +
  ylim_quantile(wine$chlorides, low_q, high_q) +
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)
```

There is a negative linear relationship between "chlorides" and "alcohol". As
"alcohol" increases, "chlorides" decreases. However, the relationship between 
the two and "quality" is not clear. For now, both features may be important to
keep.

### Middle 90% of Density vs. Residual Sugar
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Scatterplot5}

ggplot(wine, aes(x = density, y = residual.sugar, color = score)) + 
  geom_point() + 
  xlim_quantile(wine$density, low_q, high_q) +
  ylim_quantile(wine$residual.sugar, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)
```

The "residual.sugar" increases with increasing "density". The relationship
between "residual.sugar" and "density" appears to be more of an exponential
growth. The higher "quality" wines tend to have a higher 
"residual.sugar":"density" ratio. This ratio will be explored in a later section.

### Middle 90% of Density vs. Total Sulfur Dioxide
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/',  Scatterplot6}

ggplot(wine, aes(x = density, y = total.sulfur.dioxide, color = score)) +
  geom_point() + 
  xlim_quantile(wine$density, low_q, high_q) +
  ylim_quantile(wine$total.sulfur.dioxide, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette)
```

There is a linear relationship between "total.sulfur.dioxide" and "density". As
"total.sulfur.dioxide" increases, "density" increases. This plot also shows that
higher "quality" wines tend to have lower "density" values. However, the
relationship between the two and "quality" is not clear. For now, both features 
may be important to keep.

### Correlations of "density":"residual.sugar" and "density":"alcohol" vs. "quality"

The previous scatterplots showed that the "density":"residual.sugar" and
"density":"alcohol" may be important transformed features. Here, the correlation of
the ratios with quality is examined.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', results = "hide", Ratios}

# Create ratio variables
wine$density_sugar <- wine$density/wine$residual.sugar
wine$density_alcohol <- wine$density/wine$alcohol

cor(x = wine$density_sugar, y = wine$quality, method = "pearson")
cor(x = wine$density_alcohol, y = wine$quality, method = "pearson")

# Remove the ratio variables
wine <- subset(wine, select = -c(density_sugar, density_alcohol))
```

The correlation between "density":"residual.sugar" and "quality" is low, showing
that it is not an important feature for quality. The correlation between "density":"alcohol"" and "quality" is is a strong negative correlation. However,
the positive correlation between "quality" and "alcohol" is stronger. As a 
result, neither of these ratios will be analyzed further.

### Group by Quality Plots
Now that the secondary attributes are investigated, the median attributes of
each feature by quality are investigated. Using the medians can help
see overall trends in the data, that can be lost in scatterplots of the full 
data set. This section is used to confirm interpretations of previous analyses.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, fig.height = 2, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', results = "hide", QualityGroup}

# Group by quality and get median values for each level
wine_by_quality <- subset(wine, !is.na(quality)) %>%
  group_by(quality) %>%
  summarise(volatile.acidity_median = median(volatile.acidity),
            citric.acid_median = median(citric.acid),
            residual.sugar_median = median(residual.sugar),
            chlorides_median = median(chlorides),
            free.sulfur.dioxide_median = median(free.sulfur.dioxide),
            total.sulfur.dioxide_median = median(total.sulfur.dioxide),
            density_median = median(density),
            pH_median = median(pH),
            alcohol_median = median(alcohol)) %>%
  arrange(quality)

lapply((names(wine_by_quality)[2:10]), 
       function(i) ggplot(wine_by_quality, 
                          aes_string(x = i, y = "quality")) +
         geom_point() + 
         geom_smooth(method = "lm", color = "black"))

lapply((names(wine_by_quality)[2:10]), 
       function(i) cor(x = wine_by_quality[[i]], y =wine_by_quality$quality,
         method = "pearson"))

rm(wine_by_quality)
```

Medians of "chlorides", "total.sulfur.dioxide", "density", "pH", and alcohol",
appear to have strong correlations with "quality". While a linear model may not 
be appropriate for wine "quality", this plot shows that there are strong trends 
with these features and "quality". It was surprising to see such a change in the
correlations of "chlorides", "total.sulfur.dioxide", and "pH" with "quality" 
when the medians were used. Without these results, the previous analysis may 
have ruled them out.

### Secondary Citric Acid Peak
In a previous histogram, there was a secondary "citric.acid" peak at 0.49 
$g/dm^3$. Here the wines with that property are analyzed in order to see if they
are different from the average wine and if the "citric.acid" feature needs to be
reconsidered.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', results = "hide", fig.width = 7.5, fig.height = 6, CitricPeak}

# Get wines that are at the citric acid peak
wine_citric <- subset(wine, citric.acid == 0.49)

# Number of wines in the peak
dim(wine_citric)[1]

# Find the mean values of this subset
colMeans(subset(wine_citric, select = -c(quality, score)))

plot_1 <- ggplot(wine_citric, aes(score)) + geom_histogram(binwidth = 1)
plot_2 <- ggplot(wine_citric, aes(residual.sugar)) + 
  geom_histogram(binwidth = 4)
plot_3 <- ggplot(wine_citric, aes(alcohol)) + geom_histogram(binwidth = 1)
plot_4 <- ggplot(wine_citric, aes(density)) + geom_histogram(binwidth = 0.002)
 
grid.arrange(plot_1, plot_2, plot_3, plot_4, ncol = 2)

rm(wine_citric)
```

The secondary peak is at 0.49 $g/dm^3$, which is much greater than the average
concentration found at every quality level.The citric acid supposedly adds
'freshness' and flavor to wines. There are 215 wines with this acidity, and the
majority of them are mediocre wines with average sugar content, average alcohol
content, and average density (compared to global averages). Thus, the 
"citric.acid" features remains to be largely irrelevant for wine "quality".


### Residual Sugar Subsets
For this part of the analysis, the wines are separated into two sets. A set of
wines that has 4 $g/dm^3$ "residual.sugar"" content or less, and a set of wines
that has more than 4 $g/dm^3$ "residual.sugar". A previous histogram showed a
bimodal distribution of "residual.sugar" content. This analysis is done to see
if the wines in the data set should be separated by this feature.

```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', results = "hide", fig.width = 7.5, fig.height = 3, SugarSubsets}

# Divide the wines into two subsets
wine_sugar_4under <- subset(wine, residual.sugar <= 4)
wine_sugar_4over <- subset(wine, residual.sugar > 4)

plot_1 <- ggplot(subset(wine_sugar_4under, !is.na(quality) & 
                          !is.na(residual.sugar)), aes(x = residual.sugar)) + 
  geom_histogram(binwidth = 0.2) + 
  scale_x_continuous(limits=c(0, 4))

plot_2 <- ggplot(subset(wine_sugar_4over, !is.na(quality) & 
                          !is.na(residual.sugar)), aes(x = residual.sugar)) +
  geom_histogram(binwidth = 1) + 
  scale_x_continuous(limits=c(0, 25))

grid.arrange(plot_1, plot_2, ncol = 2) 
```

#### Residual Sugar Subset - 4 $g/dm^3$ and under
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', fig.width = 7.5, fig.height = 7.5, SugarSubset4under}

# Find the means and plot a matrix of plots for this subset
colMeans(subset(wine_sugar_4under, select = -c(quality, score)))
pairs.panels(subset(wine_sugar_4under, select = -score), ellipses = FALSE)

rm(wine_sugar_4under)
```

The low "residual.sugar" subset has slightly higher correlation magnitudes
between "quality" and most other attributes, on average. However, the magnitude
of correlations of all other attributes are generally lower in this subset than
the ones in the full data set. The "residual.sugar" correlations with other 
features are surprisingly much much lower in this subset. The average attributes
of this subset are mostly similar to the average attributes of the full data 
set. The exceptions include: lower "residual.sugar", "free.sulfur.dioxide", and
"total.sulfur.dioxide" values. It might be useful to separate the wine into a 
low "residual.sugar" subset since some statistics are different.

#### Residual Sugar Subset - over 4 $g/dm^3$
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', fig.width = 7.5, fig.height = 7.5, SugarSubset4over}

# Find the means and plot a matrix of plots for this subset
colMeans(subset(wine_sugar_4over, select = -c(quality, score)))
pairs.panels(subset(wine_sugar_4over, select = -score), ellipses = FALSE)

#dim(wine_sugar_4over)[1]/dim(wine)[1]*100
rm(wine_sugar_4over)
```

This subset does not appear to be significantly different from the full data set
(other than "residual.sugar") even though it contains only about 57% of the
wines. This subset does have slightly higher means in "chlorides" and
"free.sulfur.dioxide".

### Worst Wine Analysis
This section explores wines with a rating of 4 or less in order to see their 
common characteristics.
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', fig.width = 7.5, fig.height = 7.5, WorstWine}

# Create a subset for the worst wines
wine_worst <- subset(wine, quality <= 4)

# Find the means and plot a matrix of plots for this subset
colMeans(subset(wine_worst, select = -c(quality, score)))

rm(wine_worst)
```

The worst wines have higher "volatile.acidity" and "chlorides" and lower
"citric.acid", "residual.sugar", and "free.sulfur.dioxide" than the average of
all wines. Many of these properties were not viewed as main features to predict
wine "quality".

### Best Wine Analysis
This section explores wines with a rating of 8 or better in order to see their 
common characteristics.

```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', fig.width = 7.5, fig.height = 7.5, BestWine}

# Create a subset for the best wines
wine_best <- subset(wine, quality >= 8)

# Find the means and plot a matrix of plots for this subset
colMeans(subset(wine_best, select = -c(quality, score)))

rm(wine_best)
```

The best wines have lower "chlorides" and more "alcohol", which are features
that were seen to be important in predicting "quality".

### Note on Not Building a Linear Model
A linear model does not seem appropriate for predicting the quality of a wine
since "quality" is a categorical variable. In  fact, Cortez et al. (2009) use
Support Vector Machine (SVM) to predict the quality of wine. The ultimate
outcome of this analysis is to highlight the main features of Vinho Verde white
wine quality.

# Final Plots and Summary

###Summary
The features that contribute to Vinho Verde white wine "quality" the most are
"alcohol" and "density". "residual.sugar", "chlorides", "total.sulfur.dioxide", 
and "pH" may also be the next important features. These features are different 
from the predicted features ("citric.acid" and "volatile.acidity") that were 
based on the Vinho Verde description and features descriptions. The features 
that were predicted to be important were "density" and "total.sulfur.dioxide".
Correlations between the features were examined and interesting subsets were further analyzed.

### Plot One
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Plot_One}

ggplot(wine, aes(y = alcohol, x = score)) +
  geom_point(position=position_jitter(h = 0), aes(color = score)) + 
  geom_boxplot(aes(fill = score), alpha = 0.25) +  
  stat_summary(fun.y = mean, geom = "point", shape = 4, color = "black") + 
  ylim_quantile(wine$alcohol, low_q, high_q) +
  scale_color_brewer(type = color_palette, name = "Quality") +
  scale_fill_brewer(type = color_palette, name = "Quality") + 
  ylab("Alcohol (% by volume)") +
  xlab("Quality (0 - 10)") + 
  ggtitle("Scatter and Box Plots of Wine Alcohol Content, Separated by Quality")
```

Alcohol content appears to influence wine "quality" positively, if the wine is
at least mediocre (quality level of 5 and greater). Generally, as "alcohol"
content increases, wine quality also increases. The plot shows the range of
the "alcohol" content for each "quality" level and how both the median and means 
of "alcohol" content increase with "quality". There is quite a spread of the 
data for "alcohol" at each "quality" level, which signifies that it cannot be
the only feature to predict wine "quality". 

### Plot Two
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', fig.width = 7.5, fig.height = 7.5, Plot_Two}

mid<-median(subset(wine$residual.sugar, wine$residual.sugar < 25))
plot_1 <- ggplot(wine, aes(x = alcohol, y = density, color = residual.sugar)) +
  geom_point() + 
  ylim_quantile(wine$density, low_q, high_q) + 
  xlim_quantile(wine$alcohol, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_gradient2(limits=c(0, 25), midpoint = mid, low = "magenta", 
                        mid = "white", high = "green", 
                        name = expression(paste("Residual Sugar (g/", 
                                                dm^{3}, ")"))) +
  xlab("Alcohol (% by volume)") +
  ylab(expression(paste("Density (g/", cm^{3}, ")"))) +
  ggtitle("Scatterplots of Wine Alcohol Content vs. Density, 
        Colored by Residual Sugar Content")


plot_2 <- ggplot(wine, aes(x = density, y = residual.sugar, color = score)) +
  geom_point() + 
  xlim_quantile(wine$density, low_q, high_q) + 
  ylim_quantile(wine$residual.sugar, low_q, high_q) + 
  geom_smooth(method = "loess", color = "black") + 
  scale_color_brewer(type = color_palette, name = "Quality") + 
  xlab(expression(paste("Residual Sugar (g/", dm^{3}, ")"))) +
  ylab(expression(paste("Density (g/", cm^{3}, ")"))) +
  ggtitle("Scatterplots of Residual Sugar Content vs. Density, 
        Colored by Wine Quality")

grid.arrange(plot_1, plot_2, ncol = 1)
```

"density" and "alcohol" have the largest correlation with "quality", but there 
is an underlying relationship between "density", "alcohol", and 
"residual.sugar". The top plot shows how "density"" decreases with increasing
"alcohol"" content. Additionally, there is a clear separation between higher and
lower "residual.sugar" content. While "residual.sugar"and
"density":"residual.sugar" did not highly correlate with "quality", this plot
shows that there is a separation in "quality". Since these three features are
highly correlated, perhaps not all three features should be included in
predicting wine "quality". The calculated correlations are:

0.84 for "residual.sugar" & "density",

-0.78 for "alcohol" & "density", and

-0.45 for "alcohol" & "residual.sugar".

### Plot Three
```{r echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, cache = TRUE, cache.path = 'cache/', fig.path = 'figure/', Plot_Three}

ggplot(subset(wine, !is.na(quality) & !is.na(residual.sugar)), 
       aes(x = residual.sugar, fill = score)) + 
  geom_histogram() + 
  scale_x_log10() + 
  scale_fill_brewer(type = color_palette, name = "Quality") + 
  xlab(expression(paste("Residual Sugar (g/", dm^{3}, ")"))) +
  ylab("Number of Wines") + 
  ggtitle("Histogram of Residual Sugar Content, Colored by Wine Quality")
```

This last plot shows that there are two subsets of sugar content - wine for 
people who prefer sweeter wines or drier wines. It was analyzed that other than
sugar content, the wines with higher "residual.sugar" were not significantly 
different from the average of all wines. However, the wines with lower
"residual.sugar" had lower "free.sulfur.dioxide", and "total.sulfur.dioxide" 
value, on average.

# Reflection
The most difficult part of the analysis was recognizing that wine "quality"
could not be treated as a continuous variable, like diamond price. At first, I
was trying to find which feature transformations would lead to the highest
correlation with "quality". Since there are only seven "quality" categories,
correlations do not tell the whole story. After this realization, the analysis
became easier and I was able to ask interesting questions. I think finding the
interesting subsets (citric acid peak, and residual sugar subsets) will be
useful for future analysis and applying a machine learning algorithm.